<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mouse Remote - PRO</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff9800">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root { --accent-color: #ff9800; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #222; color: #fff; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }

        #header { padding: 12px; background: #2a2a2a; display: flex; gap: 10px; align-items: center; justify-content: center; border-bottom: 1px solid #111; flex-shrink: 0; }
        input[type="text"], input[type="password"] { padding: 8px; font-size: 14px; text-align: center; border-radius: 5px; border: none; background: #1a1a1a; color: #fff; }
        #connect-btn { padding: 8px 15px; font-size: 14px; cursor: pointer; background: var(--accent-color); color: white; border: none; border-radius: 5px; font-weight: bold; }
        #status { font-size: 12px; margin: 0; min-width: 80px; text-align: center; }

        #touchpad-container { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        #touchpad { flex-grow: 1; background: #30404d; touch-action: none; position: relative; }
        #edge-scroll-hint { position: absolute; right: 0; top: 0; bottom: 0; width: 10%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03)); border-left: 1px dashed rgba(255, 255, 255, 0.1); pointer-events: none; }

        #keyboard-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; color: rgba(255,255,255,0.8); pointer-events: none; white-space: pre-wrap; text-align: center; width: 90%; text-shadow: 0px 2px 10px rgba(0,0,0,0.5); font-weight: 300; }
        #hidden-keyboard-input { position: absolute; opacity: 0; top: -1000px; }

        #mouse-buttons { display: flex; height: 60px; padding: 0; background: #222; flex-shrink: 0; border-top: 1px solid #111; }
        .mouse-btn { flex: 1; font-size: 14px; background: #2b2b2b; color: #aaa; border: 1px solid #1e1e1e; border-bottom: none; border-top: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .mouse-btn:active { background: #3a3a3a; }
        .middle-btn { flex: 0 0 60px; }

        #panels-area { height: 280px; background: #2a2a2a; display: none; flex-direction: column; flex-shrink: 0; padding: 12px; overflow-y: auto; }
        .panel { display: none; width: 100%; height: 100%; }
        .panel.active { display: flex; }

        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-fill { fill: currentColor; stroke: none; }

        .panel-media { justify-content: center; align-items: center; gap: 40px; }
        .d-pad-container { position: relative; width: 200px; height: 200px; background: #1e1e1e; border-radius: 50%; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .d-btn { position: absolute; background: none; border: none; color: #888; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .d-btn:active { color: var(--accent-color); }
        .d-top { top: 10px; left: 50%; transform: translateX(-50%); width: 60px; height: 40px; }
        .d-bottom { bottom: 10px; left: 50%; transform: translateX(-50%); width: 60px; height: 40px; }
        .d-left { left: 10px; top: 50%; transform: translateY(-50%); width: 40px; height: 60px; }
        .d-right { right: 10px; top: 50%; transform: translateY(-50%); width: 40px; height: 60px; }
        .d-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2a2a2a; border: 2px solid #111; border-radius: 50%; width: 70px; height: 70px; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .d-center:active { background: var(--accent-color); border-color: var(--accent-color); }
        .media-side { display: flex; flex-direction: column; gap: 20px; }
        .side-btn { width: 50px; height: 50px; border-radius: 50%; background: #333; border: none; color: #aaa; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .side-btn:active { background: #4a4a4a; }
        .side-btn.red:active { color: #ff4444; }

        .panel-web { flex-direction: column; gap: 10px; }
        .web-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .w-btn { background: #333; border: none; color: #ddd; height: 50px; border-radius: 6px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .w-btn:active { background: var(--accent-color); color: white; }
        .w-btn.wide { grid-column: span 2; font-size: 14px; color: #888; }
        .w-btn.red-icon { color: #ff5555; }

        .panel-keys { flex-direction: column; }
        .desk-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; height: 100%; }
        .k-btn { background: #3a3a3a; border: none; color: #ccc; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 13px; cursor: pointer; padding: 2px 0; }
        .k-btn:active { background: var(--accent-color); color: white; }
        .k-btn.dark { background: #2b2b2b; transition: 0.2s; }
        .sub-text { font-size: 9px; color: #777; margin-bottom: 2px; }
        .sub-text.green { color: var(--accent-color); }
        .row-2 { grid-row: span 2; }

        /* Styl Panelu Ustawień */
        .panel-settings { flex-direction: column; gap: 20px; overflow-y: auto; padding: 15px; color: #ddd; }
        .settings-category { font-size: 12px; font-weight: bold; color: var(--accent-color); text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; }
        .setting-item-col { flex-direction: column; align-items: flex-start; gap: 10px; }
        .setting-label { display: flex; flex-direction: column; gap: 4px; }
        .setting-sub { font-size: 11px; color: #888; }

        /* Suwaki */
        input[type=range] { width: 100%; appearance: none; background: #444; height: 4px; border-radius: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-color); cursor: pointer; }

        /* Przełączniki (Toggle) */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-toggle { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider-toggle:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-toggle { background-color: var(--accent-color); }
        input:checked + .slider-toggle:before { transform: translateX(20px); }

        /* Styl panelu zasilania */
        .panel-power { grid-template-columns: 1fr 1fr; gap: 15px; align-content: center; padding: 20px; }
        .panel-power.active { display: grid; }

        .p-btn { background: #333; border: none; color: #ddd; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; font-size: 14px; gap: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .p-btn:active { background: #4a4a4a; }
        .p-btn .icon { width: 32px; height: 32px; }

        /* Panel Aplikacji */
        .panel-apps { flex-direction: column; gap: 10px; overflow-y: auto; padding: 10px; }
        .app-btn { background: #333; border: none; color: #fff; padding: 15px; border-radius: 8px; text-align: left; font-size: 14px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .app-btn:active { background: var(--accent-color); }

        /* Pasek dolny (przewijany) */
        #bottom-nav { display: flex; height: 55px; background: #222; border-top: 1px solid #111; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; overflow-x: auto; scroll-behavior: smooth; }
        #bottom-nav::-webkit-scrollbar { display: none; }
        .nav-btn { flex: 1 0 65px; min-width: 65px; background: none; border: none; color: #777; cursor: pointer; display: flex; align-items: center; justify-content: center; border-top: 3px solid transparent; transition: color 0.2s; }
        .nav-btn.active { color: var(--accent-color); border-top-color: var(--accent-color); background: #2a2a2a; }

        /* Motyw Jasny */
        [data-theme="light"] body { background: #f5f5f5; color: #111; }
        [data-theme="light"] #header, [data-theme="light"] #mouse-buttons, [data-theme="light"] #bottom-nav { background: #e0e0e0; border-color: #ccc; }
        [data-theme="light"] input[type="text"] { background: #fff; color: #111; border: 1px solid #ccc; }
        [data-theme="light"] #panels-area, [data-theme="light"] .panel-media .d-center, [data-theme="light"] .setting-item { background: #fff; }
        [data-theme="light"] .p-btn, [data-theme="light"] .app-btn, [data-theme="light"] .w-btn, [data-theme="light"] .side-btn { background: #f0f0f0; color: #111; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        [data-theme="light"] .k-btn { background: #e0e0e0; color: #111; }
        [data-theme="light"] .k-btn.dark { background: #d0d0d0; }
        [data-theme="light"] .mouse-btn { background: #f0f0f0; border-color: #ccc; color: #333; }
        [data-theme="light"] .mouse-btn:active, [data-theme="light"] .p-btn:active, [data-theme="light"] .side-btn:active { background: #d0d0d0; }
        [data-theme="light"] #touchpad { background: #d9e2ec; }
        [data-theme="light"] .settings-category { border-color: #eee; }
        [data-theme="light"] .d-pad-container { background: #e0e0e0; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        [data-theme="light"] select { background: #e0e0e0 !important; color: #111 !important; border: 1px solid #ccc !important; }
        [data-theme="light"] .d-btn { color: #555; }
        [data-theme="light"] .setting-sub { color: #666; }
        [data-theme="light"] .nav-btn.active { background: #d0d0d0; }
    </style>
</head>
<body>
    <div id="header">
        <input type="text" id="ipInput" placeholder="IP komputera" style="width: 35%;">
        <input type="password" id="pinInput" placeholder="PIN" style="width: 25%;">
        <button id="connect-btn" onclick="connect()">Połącz</button>
        <p id="status">Brak<br>połączenia</p>
    </div>

    <div id="touchpad-container">
        <div id="touchpad">
            <div id="edge-scroll-hint"></div>
            <div id="keyboard-overlay"></div>
            <input type="text" id="hidden-keyboard-input" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
        </div>

        <div id="mouse-buttons">
            <button class="mouse-btn" onclick="sendClick('left')"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="1.5"/><line x1="12" y1="3" x2="12" y2="12" stroke-width="1.5"/><line x1="3" y1="12" x2="21" y2="12" stroke-width="1.5"/></svg></button>
            <button class="mouse-btn middle-btn" onclick="sendClick('middle')"><div style="width: 12px; height: 18px; border: 1.5px solid currentColor; border-radius: 6px;"></div></button>
            <button class="mouse-btn" onclick="sendClick('right')"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="1.5"/><line x1="12" y1="3" x2="12" y2="12" stroke-width="1.5"/><line x1="3" y1="12" x2="21" y2="12" stroke-width="1.5"/></svg></button>
        </div>
    </div>

    <div id="panels-area">
        <div id="panel-settings" class="panel panel-settings">
            <div class="settings-category">Wygląd</div>
            <div class="setting-item">
                <div class="setting-label">Motyw<span class="setting-sub">Wybierz styl interfejsu</span></div>
                <select id="set-theme" onchange="applySettings()" style="background: #333; color: white; border: none; padding: 5px; border-radius: 5px; outline: none;">
                    <option value="dark">Ciemny</option>
                    <option value="light">Jasny</option>
                    <option value="system">Systemowy</option>
                </select>
            </div>
            <div class="setting-item">
                <div class="setting-label">Kolor akcentu<span class="setting-sub">Wybierz główny kolor aplikacji</span></div>
                <input type="color" id="set-accent-color" onchange="applySettings()" style="background: none; border: none; width: 40px; height: 40px; cursor: pointer; padding: 0;">
            </div>
            <div class="setting-item">
                <div class="setting-label">Tapeta Touchpada<span class="setting-sub">Ustaw własne tło z galerii</span></div>
                <div style="display: flex; gap: 5px;">
                    <button class="w-btn" style="height: 30px; padding: 0 10px; font-size: 12px;" onclick="document.getElementById('set-wallpaper').click()">Wybierz</button>
                    <button class="w-btn red-icon" style="height: 30px; padding: 0 10px; font-size: 12px;" onclick="clearWallpaper()">✖</button>
                    <input type="file" id="set-wallpaper" accept="image/*" style="display: none;" onchange="handleWallpaper(event)">
                </div>
            </div>
            <div class="settings-category">Myszka i Interfejs</div>
            <div class="setting-item">
                <div class="setting-label">Przyciski myszy<span class="setting-sub">Pokaż dolny panel z przyciskami</span></div>
                <label class="switch"><input type="checkbox" id="set-mouse-btns" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label">Tryb dla leworęcznych<span class="setting-sub">Zamień miejscami lewy i prawy przycisk</span></div>
                <label class="switch"><input type="checkbox" id="set-left-handed" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>

            <div class="settings-category">Touchpad i Gesty</div>
            <div class="setting-item">
                <div class="setting-label">Naturalne przewijanie<span class="setting-sub">Odwróć kierunek scrollowania</span></div>
                <label class="switch"><input type="checkbox" id="set-natural-scroll" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label">Kliknięcie dwoma palcami<span class="setting-sub">Działa jako prawy przycisk myszy</span></div>
                <label class="switch"><input type="checkbox" id="set-secondary-click" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>
            <div class="setting-item setting-item-col">
                <div class="setting-label" style="width: 100%; display: flex; flex-direction: row; justify-content: space-between;"><span>Prędkość kursora</span><span id="val-track" class="setting-sub">1.5x</span></div>
                <input type="range" id="set-track-speed" min="0.5" max="4.0" step="0.1" value="1.5" oninput="updateRangeVals(); applySettings()">
            </div>
            <div class="setting-item setting-item-col">
                <div class="setting-label" style="width: 100%; display: flex; flex-direction: row; justify-content: space-between;"><span>Prędkość scrollowania</span><span id="val-scroll" class="setting-sub">0.1x</span></div>
                <input type="range" id="set-scroll-speed" min="0.05" max="0.5" step="0.05" value="0.1" oninput="updateRangeVals(); applySettings()">
            </div>

            <div class="settings-category">Klawiatura</div>
            <div class="setting-item">
                <div class="setting-label">Pokaż wejście tekstu<span class="setting-sub">Wyświetlaj wpisywane znaki na touchpadzie</span></div>
                <label class="switch"><input type="checkbox" id="set-show-text" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>

            <div class="settings-category">Ekran i Opcje (General)</div>
            <div class="setting-item">
                <div class="setting-label">Nie usypiaj ekranu<span class="setting-sub">Zapobiega wygaszaniu wyświetlacza</span></div>
                <label class="switch"><input type="checkbox" id="set-disable-sleep" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label">Blokada obrotu<span class="setting-sub">Próbuj wymusić tryb pionowy telefonu</span></div>
                <label class="switch"><input type="checkbox" id="set-lock-rotation" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>

            <div class="settings-category">Opcje aplikacji natywnej (Wkrótce)</div>
            <div class="setting-item">
                <div class="setting-label">Głośność przyciskami<span class="setting-sub">Zmieniaj głośność PC z poziomu telefonu</span></div>
                <label class="switch"><input type="checkbox" id="set-vol-keys" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label">Gyro Mouse<span class="setting-sub">Steruj myszką poruszając telefonem</span></div>
                <label class="switch"><input type="checkbox" id="set-gyro-mouse" onchange="applySettings()"><span class="slider-toggle"></span></label>
            </div>
            <div class="settings-category">Nawigacja (Dolny pasek)</div>
            <div class="setting-item setting-item-col">
                <div class="setting-label">Kolejność ikon</div>
                <div id="nav-order-list" style="width: 100%; display: flex; flex-direction: column; gap: 5px;"></div>
            </div>
        </div>

        <div id="panel-apps" class="panel panel-apps">
        </div>

        <div id="panel-power" class="panel panel-power">
            <button class="p-btn" onclick="sendAction('power', 'sleep')"><svg class="icon" viewBox="0 0 24 24" style="stroke: var(--accent-color);"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>Uśpij</button>
            <button class="p-btn" onclick="sendAction('power', 'lock')"><svg class="icon" viewBox="0 0 24 24" style="stroke: #ffaa00;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Zablokuj</button>
            <button class="p-btn" onclick="sendAction('power', 'restart')"><svg class="icon" viewBox="0 0 24 24" style="stroke: #ffaa00;"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>Restart</button>
            <button class="p-btn" onclick="sendAction('power', 'shutdown')"><svg class="icon" viewBox="0 0 24 24" style="stroke: #ff4444;"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>Wyłącz</button>
        </div>

        <div id="panel-media" class="panel panel-media">
            <div class="d-pad-container">
                <button class="d-btn d-top" onclick="sendAction('media', 'volup')">+</button>
                <button class="d-btn d-bottom" onclick="sendAction('media', 'voldown')">−</button>
                <button class="d-btn d-left" onclick="sendAction('media', 'prev')"><svg class="icon icon-fill" viewBox="0 0 24 24"><polygon points="11 19 2 12 11 5 11 19"/><polygon points="22 19 13 12 22 5 22 19"/></svg></button>
                <button class="d-btn d-right" onclick="sendAction('media', 'next')"><svg class="icon icon-fill" viewBox="0 0 24 24"><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></svg></button>
                <button class="d-center" onclick="sendAction('media', 'playpause')"><svg class="icon icon-fill" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/><rect x="6" y="4" width="4" height="16" fill="transparent"/><rect x="14" y="4" width="4" height="16" fill="transparent"/></svg></button>
            </div>
            <div class="media-side">
                <button class="side-btn" onclick="sendAction('media', 'menu')"><svg class="icon" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></button>
                <button class="side-btn" onclick="sendAction('media', 'stop')"><svg class="icon icon-fill" viewBox="0 0 24 24" style="width: 14px;"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></button>
                <button class="side-btn red" onclick="sendAction('media', 'close')"><svg class="icon" viewBox="0 0 24 24" style="stroke: #ff4444;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
        </div>

        <div id="panel-web" class="panel panel-web">
            <div class="web-grid">
                <button class="w-btn" onclick="sendAction('web', 'back')"><svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'forward')"><svg class="icon" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'new_tab')"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'next_tab')"><svg class="icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="8" y="8" width="16" height="16" rx="2" fill="transparent" stroke="#555"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'close_tab')"><svg class="icon red-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'zoom_out')"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'zoom_in')"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'refresh')"><svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'home')"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></button>
                <button class="w-btn" onclick="sendAction('web', 'bookmark')"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></button>

                <div id="custom-web-shortcuts" style="display: contents;"></div>

                <button class="w-btn" id="web-edit-btn" onclick="toggleWebEditMode()"><svg class="icon" style="width:18px" viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
            </div>
        </div>

        <div id="panel-keys" class="panel panel-keys">
            <div class="desk-grid">
                <button class="k-btn" onclick="sendAction('desktop', 'esc')">Esc</button>
                <button class="k-btn" onclick="sendAction('desktop', 'tab')">Tab</button>
                <button class="k-btn" id="fn-btn" onclick="toggleFn()"><span class="sub-text green">FN</span>NUM</button>
                <button class="k-btn dark" onclick="sendDesk('backspace', 'f1')"><span class="sub-text">F1</span>&larr;</button>
                <button class="k-btn dark" onclick="sendDesk('/', 'f2')"><span class="sub-text">F2</span>/</button>
                <button class="k-btn dark" onclick="sendDesk('*', 'f3')"><span class="sub-text">F3</span>*</button>
                <button class="k-btn dark" onclick="sendAction('desktop', '-')">-</button>

                <button class="k-btn" onclick="sendAction('desktop', 'insert')">Insert</button>
                <button class="k-btn" onclick="sendAction('desktop', 'home')">Home</button>
                <button class="k-btn" onclick="sendAction('desktop', 'page_up')">PgUp</button>
                <button class="k-btn dark" onclick="sendDesk('7', 'f4')"><span class="sub-text">F4</span>7</button>
                <button class="k-btn dark" onclick="sendDesk('8', 'f5')"><span class="sub-text">F5</span>8</button>
                <button class="k-btn dark" onclick="sendDesk('9', 'f6')"><span class="sub-text">F6</span>9</button>
                <button class="k-btn dark row-2" onclick="sendAction('desktop', '+')">+</button>

                <button class="k-btn" onclick="sendAction('desktop', 'delete')">Delete</button>
                <button class="k-btn" onclick="sendAction('desktop', 'end')">End</button>
                <button class="k-btn" onclick="sendAction('desktop', 'page_down')">PgDn</button>
                <button class="k-btn dark" onclick="sendDesk('4', 'f7')"><span class="sub-text">F7</span>4</button>
                <button class="k-btn dark" onclick="sendDesk('5', 'f8')"><span class="sub-text">F8</span>5</button>
                <button class="k-btn dark" onclick="sendDesk('6', 'f9')"><span class="sub-text">F9</span>6</button>

                <button class="k-btn dark" id="btn-ctrl" onclick="toggleModifier('ctrl')">Ctrl</button>
                <button class="k-btn dark" onclick="sendAction('desktop', 'up')">▲</button>
                <button class="k-btn dark" id="btn-alt" onclick="toggleModifier('alt')">Alt</button>
                <button class="k-btn dark" onclick="sendDesk('1', 'f10')"><span class="sub-text">F10</span>1</button>
                <button class="k-btn dark" onclick="sendDesk('2', 'f11')"><span class="sub-text">F11</span>2</button>
                <button class="k-btn dark" onclick="sendDesk('3', 'f12')"><span class="sub-text">F12</span>3</button>
                <button class="k-btn dark row-2" onclick="sendAction('desktop', 'enter')">enter</button>

                <button class="k-btn dark" onclick="sendAction('desktop', 'left')">◀</button>
                <button class="k-btn dark" onclick="sendAction('desktop', 'down')">▼</button>
                <button class="k-btn dark" onclick="sendAction('desktop', 'right')">▶</button>
                <button class="k-btn dark" id="btn-shift" onclick="toggleModifier('shift')">Shift</button>
                <button class="k-btn dark" onclick="sendAction('desktop', '0')"><span class="sub-text" style="color:transparent">.</span>0</button>
                <button class="k-btn dark" onclick="sendAction('desktop', '.')"><span class="sub-text" style="color:transparent">.</span>.</button>
            </div>
        </div>
    </div>

    <div id="bottom-nav">
        <button class="nav-btn" data-id="settings" onclick="togglePanel('settings', this)"><svg class="icon" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <button class="nav-btn" data-id="power" onclick="togglePanel('power', this)"><svg class="icon" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M3 5.5L10 4.5V11.5H3V5.5ZM11 4.3L21 3V11.5H11V4.3ZM3 12.5H10V19.5L3 18.5V12.5ZM11 12.5H21V21L11 19.7V12.5Z"/></svg></button>
        <button class="nav-btn" data-id="media" onclick="togglePanel('media', this)"><svg class="icon" viewBox="0 0 24 24" style="stroke:var(--accent-color);"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8" fill="var(--accent-color)"/></svg></button>
        <button class="nav-btn" data-id="apps" onclick="togglePanel('apps', this)"><svg class="icon" viewBox="0 0 24 24" style="stroke:var(--accent-color);"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg></button>
        <button class="nav-btn" data-id="web" onclick="togglePanel('web', this)"><svg class="icon" viewBox="0 0 24 24" style="stroke:var(--accent-color);"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></button>
        <button class="nav-btn" data-id="keyboard" onclick="toggleKeyboard(this)"><svg class="icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="6.01" y2="8"/><line x1="10" y1="8" x2="10.01" y2="8"/><line x1="14" y1="8" x2="14.01" y2="8"/><line x1="18" y1="8" x2="18.01" y2="8"/><line x1="8" y1="12" x2="8.01" y2="12"/><line x1="12" y1="12" x2="12.01" y2="12"/><line x1="16" y1="12" x2="16.01" y2="12"/><line x1="7" y1="16" x2="17" y2="16"/></svg></button>
        <button class="nav-btn" data-id="keys" onclick="togglePanel('keys', this)"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg></button>
    </div>

    <script>
        let ws;
        let lastX = 0, lastY = 0;
        let isMoving = false;
        let isEdgeScrolling = false;
        let maxFingers = 0;
        let fnMode = false;

        let ctrlPressed = false;
        let altPressed = false;
        let shiftPressed = false;
        let wakeLock = null;

        // --- System Ustawień ---
        let cfg = {
            trackingSpeed: parseFloat(localStorage.getItem('cfg_trackingSpeed')) || 1.5,
            scrollingSpeed: parseFloat(localStorage.getItem('cfg_scrollingSpeed')) || 0.1,
            showMouseBtns: localStorage.getItem('cfg_showMouseBtns') !== 'false',
            leftHanded: localStorage.getItem('cfg_leftHanded') === 'true',
            showText: localStorage.getItem('cfg_showText') !== 'false',
            accentColor: localStorage.getItem('cfg_accentColor') || '#ff9800',
            wallpaper: localStorage.getItem('cfg_wallpaper') || '',
            theme: localStorage.getItem('cfg_theme') || 'system',
            naturalScroll: localStorage.getItem('cfg_naturalScroll') === 'true',
            secondaryClick: localStorage.getItem('cfg_secondaryClick') !== 'false',
            disableSleep: localStorage.getItem('cfg_disableSleep') === 'true',
            lockRotation: localStorage.getItem('cfg_lockRotation') === 'true',
            volKeys: localStorage.getItem('cfg_volKeys') === 'true',
            gyroMouse: localStorage.getItem('cfg_gyroMouse') === 'true',
            panelOrder: JSON.parse(localStorage.getItem('cfg_panelOrder')) || ['settings', 'power', 'media', 'apps', 'web', 'keyboard', 'keys']
        };

        const panelNames = { 'settings': 'Ustawienia', 'power': 'Zasilanie', 'media': 'Multimedia', 'apps': 'Aplikacje', 'web': 'Przeglądarka', 'keyboard': 'Pisanie', 'keys': 'Skróty' };

        function applyNavOrder() {
            const nav = document.getElementById('bottom-nav');
            cfg.panelOrder.forEach(id => {
                const btn = nav.querySelector(`[data-id="${id}"]`);
                if (btn) nav.appendChild(btn);
            });
            localStorage.setItem('cfg_panelOrder', JSON.stringify(cfg.panelOrder));
        }

        function renderNavOrderUI() {
            const list = document.getElementById('nav-order-list');
            if (!list) return;
            list.innerHTML = '';
            cfg.panelOrder.forEach((id, index) => {
                const row = document.createElement('div');
                row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
                row.style.background = 'var(--accent-color)'; row.style.padding = '5px 10px'; row.style.borderRadius = '5px'; row.style.color = '#fff';

                const name = document.createElement('span');
                name.innerText = panelNames[id]; name.style.fontSize = '14px'; name.style.fontWeight = 'bold';

                const btns = document.createElement('div');
                const upBtn = document.createElement('button');
                upBtn.innerHTML = '▲'; upBtn.className = 'w-btn'; upBtn.style.height = '28px'; upBtn.style.width = '35px'; upBtn.style.padding = '0';
                upBtn.onclick = () => moveNav(index, -1);

                const downBtn = document.createElement('button');
                downBtn.innerHTML = '▼'; downBtn.className = 'w-btn'; downBtn.style.height = '28px'; downBtn.style.width = '35px'; downBtn.style.padding = '0'; downBtn.style.marginLeft = '5px';
                downBtn.onclick = () => moveNav(index, 1);

                if (index === 0) upBtn.style.visibility = 'hidden';
                if (index === cfg.panelOrder.length - 1) downBtn.style.visibility = 'hidden';

                btns.appendChild(upBtn); btns.appendChild(downBtn);
                row.appendChild(name); row.appendChild(btns);
                list.appendChild(row);
            });
        }

        function moveNav(index, dir) {
            if (index + dir < 0 || index + dir >= cfg.panelOrder.length) return;
            const temp = cfg.panelOrder[index];
            cfg.panelOrder[index] = cfg.panelOrder[index + dir];
            cfg.panelOrder[index + dir] = temp;
            applyNavOrder();
            renderNavOrderUI();
        }

        function loadSettingsUI() {
            if(document.getElementById('set-mouse-btns')) document.getElementById('set-mouse-btns').checked = cfg.showMouseBtns;
            if(document.getElementById('set-left-handed')) document.getElementById('set-left-handed').checked = cfg.leftHanded;
            if(document.getElementById('set-show-text')) document.getElementById('set-show-text').checked = cfg.showText;
            if(document.getElementById('set-track-speed')) document.getElementById('set-track-speed').value = cfg.trackingSpeed;
            if(document.getElementById('set-scroll-speed')) document.getElementById('set-scroll-speed').value = cfg.scrollingSpeed;
            if(document.getElementById('set-accent-color')) document.getElementById('set-accent-color').value = cfg.accentColor;
            if(document.getElementById('set-theme')) document.getElementById('set-theme').value = cfg.theme;
            if(document.getElementById('set-natural-scroll')) document.getElementById('set-natural-scroll').checked = cfg.naturalScroll;
            if(document.getElementById('set-secondary-click')) document.getElementById('set-secondary-click').checked = cfg.secondaryClick;
            if(document.getElementById('set-disable-sleep')) document.getElementById('set-disable-sleep').checked = cfg.disableSleep;
            if(document.getElementById('set-lock-rotation')) document.getElementById('set-lock-rotation').checked = cfg.lockRotation;
            if(document.getElementById('set-vol-keys')) document.getElementById('set-vol-keys').checked = cfg.volKeys;
            if(document.getElementById('set-gyro-mouse')) document.getElementById('set-gyro-mouse').checked = cfg.gyroMouse;
            
            updateRangeVals();
            applySettings(false);
            applyNavOrder();
            renderNavOrderUI();
            document.getElementById('ipInput').value = localStorage.getItem('savedIP') || '';
            document.getElementById('pinInput').value = localStorage.getItem('savedPIN') || '';
        }

        function updateRangeVals() {
            const valTrack = document.getElementById('val-track');
            const valScroll = document.getElementById('val-scroll');
            if(valTrack) valTrack.innerText = document.getElementById('set-track-speed').value + 'x';
            if(valScroll) valScroll.innerText = document.getElementById('set-scroll-speed').value + 'x';
        }

        async function manageScreenApis() {
            // Wake Lock
            if (cfg.disableSleep) {
                try {
                    if (!wakeLock) wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) { console.log("Wake Lock błąd:", err); }
            } else {
                if (wakeLock) {
                    wakeLock.release().then(() => wakeLock = null);
                }
            }
            // Screen Rotation
            if (cfg.lockRotation) {
                try { screen.orientation.lock('portrait').catch(e=>console.log("Ignoruj błąd rotacji", e)); } catch(e){}
            } else {
                try { screen.orientation.unlock(); } catch(e){}
            }
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') manageScreenApis();
        });

        function applySettings(save = true) {
            cfg.showMouseBtns = document.getElementById('set-mouse-btns').checked;
            cfg.leftHanded = document.getElementById('set-left-handed').checked;
            cfg.showText = document.getElementById('set-show-text').checked;
            cfg.trackingSpeed = parseFloat(document.getElementById('set-track-speed').value);
            cfg.scrollingSpeed = parseFloat(document.getElementById('set-scroll-speed').value);
            cfg.accentColor = document.getElementById('set-accent-color').value;
            cfg.theme = document.getElementById('set-theme').value;
            cfg.naturalScroll = document.getElementById('set-natural-scroll').checked;
            cfg.secondaryClick = document.getElementById('set-secondary-click').checked;
            cfg.disableSleep = document.getElementById('set-disable-sleep').checked;
            cfg.lockRotation = document.getElementById('set-lock-rotation').checked;
            cfg.volKeys = document.getElementById('set-vol-keys').checked;
            cfg.gyroMouse = document.getElementById('set-gyro-mouse').checked;

            if (save) {
                localStorage.setItem('cfg_showMouseBtns', cfg.showMouseBtns);
                localStorage.setItem('cfg_leftHanded', cfg.leftHanded);
                localStorage.setItem('cfg_showText', cfg.showText);
                localStorage.setItem('cfg_trackingSpeed', cfg.trackingSpeed);
                localStorage.setItem('cfg_scrollingSpeed', cfg.scrollingSpeed);
                localStorage.setItem('cfg_accentColor', cfg.accentColor);
                localStorage.setItem('cfg_theme', cfg.theme);
                localStorage.setItem('cfg_naturalScroll', cfg.naturalScroll);
                localStorage.setItem('cfg_secondaryClick', cfg.secondaryClick);
                localStorage.setItem('cfg_disableSleep', cfg.disableSleep);
                localStorage.setItem('cfg_lockRotation', cfg.lockRotation);
                localStorage.setItem('cfg_volKeys', cfg.volKeys);
                localStorage.setItem('cfg_gyroMouse', cfg.gyroMouse);
                try { localStorage.setItem('cfg_wallpaper', cfg.wallpaper); } catch(e) { alert("Zdjęcie za duże (max ~3-5MB)."); cfg.wallpaper = ''; }
            }

            document.documentElement.style.setProperty('--accent-color', cfg.accentColor);

            let actualTheme = cfg.theme;
            if (actualTheme === 'system') {
                actualTheme = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
            }
            if (actualTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            document.getElementById('mouse-buttons').style.display = cfg.showMouseBtns ? 'flex' : 'none';
            document.getElementById('mouse-buttons').style.flexDirection = cfg.leftHanded ? 'row-reverse' : 'row';
            document.getElementById('keyboard-overlay').style.display = cfg.showText ? 'block' : 'none';

            const tp = document.getElementById('touchpad');
            if (cfg.wallpaper) {
                tp.style.backgroundImage = `url(${cfg.wallpaper})`;
                tp.style.backgroundSize = 'cover';
                tp.style.backgroundPosition = 'center';
            } else {
                tp.style.backgroundImage = 'none';
            }

            const scrollHint = document.getElementById('edge-scroll-hint');
            if (cfg.leftHanded) {
                scrollHint.style.right = 'auto';
                scrollHint.style.left = '0';
                scrollHint.style.borderLeft = 'none';
                scrollHint.style.borderRight = '1px dashed rgba(255, 255, 255, 0.1)';
            } else {
                scrollHint.style.left = 'auto';
                scrollHint.style.right = '0';
                scrollHint.style.borderRight = 'none';
                scrollHint.style.borderLeft = '1px dashed rgba(255, 255, 255, 0.1)';
            }

            manageScreenApis();
        }

        window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
            if (cfg.theme === 'system') applySettings(false);
        });

        function handleWallpaper(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                cfg.wallpaper = e.target.result;
                applySettings();
            };
            reader.readAsDataURL(file);
        }

        function clearWallpaper() {
            cfg.wallpaper = '';
            document.getElementById('set-wallpaper').value = '';
            applySettings();
        }

        window.addEventListener('DOMContentLoaded', loadSettingsUI);

        const statusLabel = document.getElementById('status');
        const touchpad = document.getElementById('touchpad');
        const hiddenInput = document.getElementById('hidden-keyboard-input');
        const keyboardOverlay = document.getElementById('keyboard-overlay');

        function connect() {
            const ip = document.getElementById('ipInput').value;
            const pin = document.getElementById('pinInput').value;
            
            localStorage.setItem('savedIP', ip);
            localStorage.setItem('savedPIN', pin);

            if(ws) ws.close(); 
            ws = new WebSocket(`ws://${ip}:8765`);
            
            ws.onopen = () => {
                ws.send(JSON.stringify({ action: "auth", pin: pin }));
            };
            ws.onerror = () => { statusLabel.innerHTML = "Błąd!"; statusLabel.style.color = "#ff4444"; };
            ws.onclose = () => { statusLabel.innerHTML = "Rozłączono"; statusLabel.style.color = "#ff4444"; };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'auth_ok') {
                        statusLabel.innerHTML = "Połączono!";
                        statusLabel.style.color = "var(--accent-color)";
                    } else if (data.type === 'auth_fail') {
                        statusLabel.innerHTML = "Zły PIN!";
                        statusLabel.style.color = "#ff4444";
                        alert("Błędny kod PIN!");
                    } else if (data.type === 'apps_list') {
                        const container = document.getElementById('panel-apps');
                        if (!container) return;
                        container.innerHTML = '';
                        data.apps.forEach(app => {
                            const btn = document.createElement('button');
                            btn.className = 'app-btn';
                            btn.innerText = app.title;
                            btn.onclick = () => ws.send(JSON.stringify({ action: "switch_app", hwnd: app.hwnd }));
                            container.appendChild(btn);
                        });
                        const refreshBtn = document.createElement('button');
                        refreshBtn.className = 'app-btn';
                        refreshBtn.style.color = 'var(--accent-color)';
                        refreshBtn.innerText = '↻ Odśwież listę';
                        refreshBtn.onclick = () => ws.send(JSON.stringify({ action: "get_apps" }));
                        container.appendChild(refreshBtn);
                    }
                } catch (e) {
                    console.error("Błąd parsowania:", e);
                }
            };
        }

        let webShortcuts = JSON.parse(localStorage.getItem('webShortcuts')) || [
            { name: "YouTube", url: "https://www.youtube.com" },
            { name: "Netflix", url: "https://www.netflix.com" }
        ];
        let isWebEditMode = false;

        function renderWebShortcuts() {
            const container = document.getElementById('custom-web-shortcuts');
            if (!container) return;
            container.innerHTML = '';
            webShortcuts.forEach((shortcut, index) => {
                const btn = document.createElement('button');
                btn.className = 'w-btn wide';
                if (isWebEditMode) {
                    btn.style.color = '#ff4444';
                    btn.innerText = '✖ ' + shortcut.name;
                } else {
                    btn.innerText = shortcut.name;
                    btn.style.color = '#888';
                }

                btn.onclick = () => {
                    if (isWebEditMode) {
                        webShortcuts.splice(index, 1);
                        saveAndRenderWebShortcuts();
                    } else {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ action: "web", command: "open_url", url: shortcut.url }));
                        }
                    }
                };
                container.appendChild(btn);
            });

            if (isWebEditMode) {
                const addBtn = document.createElement('button');
                addBtn.className = 'w-btn wide';
                addBtn.style.color = 'var(--accent-color)';
                addBtn.innerText = '➕ Dodaj';
                addBtn.onclick = () => {
                    const name = prompt("Podaj nazwę skrótu (np. Twitch):");
                    if (!name) return;
                    let url = prompt("Podaj adres URL:", "https://");
                    if (!url) return;
                    if (!url.startsWith('http')) url = 'https://' + url;
                    webShortcuts.push({ name, url });
                    saveAndRenderWebShortcuts();
                };
                container.appendChild(addBtn);
            }
        }

        function saveAndRenderWebShortcuts() {
            localStorage.setItem('webShortcuts', JSON.stringify(webShortcuts));
            renderWebShortcuts();
        }

        function toggleWebEditMode() {
            isWebEditMode = !isWebEditMode;
            renderWebShortcuts();
            const editBtn = document.getElementById('web-edit-btn');
            if (editBtn) {
                editBtn.style.color = isWebEditMode ? 'var(--accent-color)' : '#ddd';
            }
        }

        renderWebShortcuts();

        function toggleModifier(mod) {
            if (mod === 'ctrl') {
                ctrlPressed = !ctrlPressed;
                const btn = document.getElementById('btn-ctrl');
                btn.style.background = ctrlPressed ? 'var(--accent-color)' : '#2b2b2b';
                btn.style.color = ctrlPressed ? '#fff' : '#ccc';
                if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: "modifier", key: "ctrl", state: ctrlPressed ? "down" : "up" }));
            } else if (mod === 'alt') {
                altPressed = !altPressed;
                const btn = document.getElementById('btn-alt');
                btn.style.background = altPressed ? 'var(--accent-color)' : '#2b2b2b';
                btn.style.color = altPressed ? '#fff' : '#ccc';
                if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: "modifier", key: "alt", state: altPressed ? "down" : "up" }));
            } else if (mod === 'shift') {
                shiftPressed = !shiftPressed;
                const btn = document.getElementById('btn-shift');
                btn.style.background = shiftPressed ? 'var(--accent-color)' : '#2b2b2b';
                btn.style.color = shiftPressed ? '#fff' : '#ccc';
                if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: "modifier", key: "shift", state: shiftPressed ? "down" : "up" }));
            }
        }

        function releaseModifiers() {
            if (ctrlPressed) {
                ctrlPressed = false;
                const btn = document.getElementById('btn-ctrl');
                if(btn) { btn.style.background = '#2b2b2b'; btn.style.color = '#ccc'; }
                if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: "modifier", key: "ctrl", state: "up" }));
            }
            if (altPressed) {
                altPressed = false;
                const btn = document.getElementById('btn-alt');
                if(btn) { btn.style.background = '#2b2b2b'; btn.style.color = '#ccc'; }
                if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: "modifier", key: "alt", state: "up" }));
            }
        }

        function sendClick(buttonType) {
            if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: "click", button: buttonType }));
            releaseModifiers();
        }

        function sendAction(category, command) {
            if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: category, command: command }));
            if (category === 'desktop') releaseModifiers();
        }

        function toggleFn() {
            fnMode = !fnMode;
            const btn = document.getElementById('fn-btn');
            if (fnMode) {
                btn.style.background = 'var(--accent-color)';
                btn.style.color = '#fff';
            } else {
                btn.style.background = '#3a3a3a';
                btn.style.color = '#ccc';
            }
        }

        function sendDesk(primaryCmd, fnCmd) {
            let cmd = fnMode ? fnCmd : primaryCmd;
            sendAction('desktop', cmd);
        }

        function togglePanel(panelName, btnElement) {
            const panelsArea = document.getElementById('panels-area');
            if (btnElement.classList.contains('active')) {
                btnElement.classList.remove('active');
                panelsArea.style.display = 'none';
                return;
            }
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            btnElement.classList.add('active');
            if (panelName !== 'none') {
                panelsArea.style.display = 'flex';
                const targetPanel = document.getElementById('panel-' + panelName);
                if(targetPanel) targetPanel.classList.add('active');
                if (panelName === 'apps' && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ action: "get_apps" }));
                }
            } else {
                panelsArea.style.display = 'none';
            }
            hiddenInput.blur();
        }

        function toggleKeyboard(btnElement) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('panels-area').style.display = 'none';
            btnElement.classList.add('active');

            hiddenInput.value = " ";
            previousText = " ";
            keyboardOverlay.innerText = "";
            hiddenInput.focus();
        }

        hiddenInput.value = " ";
        let previousText = " ";

        hiddenInput.addEventListener('input', (e) => {
            const currentText = hiddenInput.value;

            if (ws && ws.readyState === WebSocket.OPEN) {
                if (currentText.length > previousText.length) {
                    const addedChars = currentText.slice(previousText.length);
                    for (let char of addedChars) {
                        ws.send(JSON.stringify({ action: "type", char: char }));
                    }
                    keyboardOverlay.innerText += addedChars;
                } else if (currentText.length < previousText.length) {
                    const removedCount = previousText.length - currentText.length;
                    for (let i = 0; i < removedCount; i++) {
                        ws.send(JSON.stringify({ action: "key", key: "backspace" }));
                    }
                    keyboardOverlay.innerText = keyboardOverlay.innerText.slice(0, -removedCount);
                }
                releaseModifiers();
            }

            if (hiddenInput.value === "") {
                hiddenInput.value = " ";
                previousText = " ";
            } else {
                previousText = hiddenInput.value;
            }
        });

        hiddenInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ action: "key", key: "enter" }));
                }
                hiddenInput.value = " ";
                previousText = " ";
                keyboardOverlay.innerText = "";
                releaseModifiers();
            } else if (e.key === 'Backspace' && hiddenInput.value === " ") {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ action: "key", key: "backspace" }));
                }
                keyboardOverlay.innerText = keyboardOverlay.innerText.slice(0, -1);
                releaseModifiers();
            }
        });

        hiddenInput.addEventListener('blur', () => {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        });

        touchpad.addEventListener('touchstart', (e) => {
            isMoving = false;
            maxFingers = Math.max(maxFingers, e.touches.length);

            if (e.touches.length === 1) {
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;

                if (cfg.leftHanded) {
                    isEdgeScrolling = lastX < window.innerWidth * 0.1;
                } else {
                    isEdgeScrolling = lastX > window.innerWidth * 0.9;
                }
            } else if (e.touches.length === 2) {
                lastY = e.touches[0].clientY; // Scrollowanie z 2 palców
            }
        });

        touchpad.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            if (e.touches.length === 1) {
                let currentX = e.touches[0].clientX; let currentY = e.touches[0].clientY;
                if (isEdgeScrolling) {
                    isMoving = true;
                    let dir = cfg.naturalScroll ? -1 : 1;
                    ws.send(JSON.stringify({ action: "scroll", dy: (lastY - currentY) * cfg.scrollingSpeed * dir }));
                    lastY = currentY;
                } else {
                    let dx = currentX - lastX; let dy = currentY - lastY;
                    if (Math.abs(dx) > 0.5 || Math.abs(dy) > 0.5) {
                        isMoving = true;
                        let finalDx = Math.round(dx * cfg.trackingSpeed); let finalDy = Math.round(dy * cfg.trackingSpeed);
                        if (finalDx !== 0 || finalDy !== 0) {
                            ws.send(JSON.stringify({ action: "move", dx: finalDx, dy: finalDy }));
                            lastX = currentX; lastY = currentY;
                        }
                    }
                }
            } else if (e.touches.length === 2) {
                // Nowość: Przewijanie dwoma palcami w dowolnym miejscu ekranu
                let currentY = e.touches[0].clientY;
                let dy = lastY - currentY;
                if (Math.abs(dy) > 0.5) {
                    isMoving = true;
                    let dir = cfg.naturalScroll ? -1 : 1;
                    ws.send(JSON.stringify({ action: "scroll", dy: dy * cfg.scrollingSpeed * dir }));
                    lastY = currentY;
                }
            }
        }, { passive: false });

        touchpad.addEventListener('touchend', (e) => {
            if (e.touches.length === 0) {
                if (!isMoving) {
                    if (maxFingers === 1) {
                        sendClick('left');
                    } else if (maxFingers === 2 && cfg.secondaryClick) {
                        sendClick('right'); // Nowość: Prawy klik jako "tapnięcie" 2 palcami
                    }
                }
                isEdgeScrolling = false;
                maxFingers = 0;
            }
        });
    </script>
</body>
</html>